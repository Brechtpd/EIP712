
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>EIP712 demo</title>
  </head>
  <body>
    <p>
      This page demonstrates how to sign EIP712 typed data using MetaMask and
      verify it in Solidity.
    </p>
    <p>
      To use this demo, you need at least version 4.14.0 of MetaMask which supports eth_signTypedData_v3.
    </p>

    <button id="signBtn">Click here to sign some typed data</button>
    <br />
    <textarea readonly rows=10 cols=80 id="response">
    </textarea>

    <br />

    <p>
      The signature generated by MetaMask, as well as your wallet address, has
      been inserted into the Solidity code above. The code hashes the data you
      just signed, runs ecrecover with yoour signature, and compares it with
      your wallet address.
    </p>
    <p>
        If Remix displays <pre>0: bool: true</pre> that's great! Your wallet
        address was successfully authenticated against the signature.
    </p>

    <br />

    <p>An example:</p>
    <script>

function parseSignature(signature) {
  var r = signature.substring(0, 64);
  var s = signature.substring(64, 128);
  var v = signature.substring(128, 130);

  return {
      r: "0x" + r,
      s: "0x" + s,
      v: parseInt(v, 16)
  }
}

window.onload = function (e) {
  var res = document.getElementById("response");
  res.style.display = "none";

  // force the user to unlock their MetaMask
  if (web3.eth.accounts[0] == null) {
    alert("Please unlock MetaMask first");
  }

  var signBtn = document.getElementById("signBtn");
  signBtn.onclick = function(e) {
    if (web3.eth.accounts[0] == null) {
      return;
    }

const data = '{"types":{"EIP712Domain":[{"name":"name","type":"string"},{"name":"version","type":"string"}],"Order":[{"name":"amountS","type":"uint"},{"name":"amountB","type":"uint"},{"name":"feeAmount","type":"uint"},{"name":"validSince","type":"uint"},{"name":"validUntil","type":"uint"},{"name":"owner","type":"address"},{"name":"tokenS","type":"address"},{"name":"tokenB","type":"address"},{"name":"dualAuthAddr","type":"address"},{"name":"broker","type":"address"},{"name":"orderInterceptor","type":"address"},{"name":"wallet","type":"address"},{"name":"tokenRecipient","type":"address"},{"name":"feeToken","type":"address"},{"name":"walletSplitPercentage","type":"uint16"},{"name":"tokenSFeePercentage","type":"uint16"},{"name":"tokenBFeePercentage","type":"uint16"},{"name":"allOrNone","type":"bool"}]},"primaryType":"Order","domain":{"name":"Loopring Protocol","version":"2"},"message":{"amountS":"10000000000000000000","amountB":"1000000000000000000","feeAmount":"1000000000000000000","validSince":"1542048338","validUntil":"0","owner":"0xe22f0871c0ce9493ca29fbc8a996f9ae7d9c682a","tokenS":"0xfae5b9e589a984a7c81c6b8387bf6b0d4079e5a4","tokenB":"0x75fab201e70512a42e6becf03961cbad6bbb0b14","dualAuthAddr":"0xffe0dfd7639a4f8ee0398db10aede1e56e872591","broker":"0x0","orderInterceptor":"0x0","wallet":"0x5d6eb97454dfc47eb72e86c19a50183c22f9e0d5","tokenRecipient":"0xe22f0871c0ce9493ca29fbc8a996f9ae7d9c682a","feeToken":"0xfae5b9e589a984a7c81c6b8387bf6b0d4079e5a4","walletSplitPercentage":10,"tokenSFeePercentage":0,"tokenBFeePercentage":0,"allOrNone":false}}';

    const signer = web3.eth.accounts[0];

    web3.currentProvider.sendAsync(
      {
        method: "eth_signTypedData_v3",
        params: [signer, data],
        from: signer
      }, 
      function(err, result) {
        if (err || result.error) {
          return console.error(result);
        }

        const signature = parseSignature(result.result.substring(2));

        res.style.display = "block";
        // res.value = genSolidityVerifier(signature, signer);
        res.value = signature.v + signature.r + signature.s;
	//res.value = data;
      }
    );
  };
}

    </script>
  </body>
</html>
